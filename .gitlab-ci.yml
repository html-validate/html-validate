image: node:10

stages:
  - prepare
  - build
  - test
  - compatibility
  - release
  - postrelease

NPM:
  stage: prepare
  cache:
    key: "${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    paths:
    - node_modules/
  artifacts:
    name: ${CI_PROJECT_PATH_SLUG}-${CI_PIPELINE_ID}-npm
    paths:
      - node_modules/
  script:
    - node --version
    - npm --version
    - npm ci

Build:
  stage: build
  artifacts:
    name: ${CI_PROJECT_PATH_SLUG}-${CI_PIPELINE_ID}-build
    paths:
      - build/
  script:
    - node_modules/.bin/grunt build:ci

pages:
  stage: build
  script: node_modules/.bin/grunt build docs
  artifacts:
    paths:
      - public
  only:
    - tags
    - triggers

ESLint:
  stage: test
  variables:
    ESLINT_STRICT: 1
  script:
    - node_modules/.bin/grunt eslint

Jest:
  stage: test
  script: node_modules/.bin/jest src
  coverage: /Lines\s+:\s(\d+.\d+%)/
  artifacts:
    name: ${CI_PROJECT_PATH_SLUG}-${CI_PIPELINE_ID}-coverage
    paths:
      - coverage

TSLint:
  stage: test
  script:
    - node_modules/.bin/grunt tslint

Prettier:
  stage: test
  script:
    - npm run prettier:check

Docs:
  stage: test
  script:
    - node_modules/.bin/grunt ts docs
    - ./bin/html-validate.js docs/**/*.html public/**/.html
    - node_modules/.bin/jest docs
    - git status --porcelain
    - test -z "$(git status --porcelain)" || (echo 'working copy dirty, need to commit updated specs'; exit 1)

.compat: &compat
  stage: compatibility
  dependencies: []
  before_script:
    - npm ci
  script:
    - node_modules/.bin/grunt build

Node 8.x (LTS):
  <<: *compat
  image: node:8
  before_script:
    - npm install

Node 10.x (LTS):
  <<: *compat
  image: node:10

Node 11.x (current):
  <<: *compat
  image: node:11

Publish to NPM:
  stage: release
  only:
    - tags
  script:
    - echo '//registry.npmjs.org/:_authToken=${NPM_TOKEN}' > ~/.npmrc
    - export PKG_VERSION=v$(node -p "require('./package.json').version")
    - echo ${CI_COMMIT_TAG}
    - echo ${PKG_VERSION}
    - test ${CI_COMMIT_TAG} = ${PKG_VERSION}
    - npm publish

.downstream: &downstream
  stage: postrelease
  only:
    - tags
  dependencies: []
  before_script:
    - sleep 10

grunt-html-validate:
  <<: *downstream
  variables:
    PROJECT_ID: 24
  script:
    - scripts/trigger-downstream "${PROJECT_ID}" "${DOWNSTREAM_GRUNT_TOKEN}" "master" "${CI_COMMIT_TAG}"

html-validate-angular:
  <<: *downstream
  variables:
    PROJECT_ID: 45
  script:
    - scripts/trigger-downstream "${PROJECT_ID}" "${DOWNSTREAM_ANGULAR_TOKEN}" "master" "${CI_COMMIT_TAG}"

html-validate-vue:
  <<: *downstream
  variables:
    PROJECT_ID: 40
  script:
    - scripts/trigger-downstream "${PROJECT_ID}" "${DOWNSTREAM_VUE_TOKEN}" "master" "${CI_COMMIT_TAG}"

protractor-html-validate:
  <<: *downstream
  variables:
    PROJECT_ID: 42
  script:
    - scripts/trigger-downstream "${PROJECT_ID}" "${DOWNSTREAM_PROTRACTOR_TOKEN}" "master" "${CI_COMMIT_TAG}"
